---
title: "Redfin-BostonMag-Data-Scrape"
author: "ZsuZsuChen"
date: "11/22/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

Scraping housing market trend data from Redfin for Boston and individual neighborhoods. Data was updated in January 2020.

```{r, warning=FALSE}
library(rvest)
library(stringr)
library(stringi)
library(tidyverse)
library(dplyr)
```

--START OF CODING--

Read html from Redfin for aggregrate housing sale trends in different Boston neighborhoods. Data from January 2020.

```{r}

bos <- read_html("https://www.redfin.com/city/1826/MA/Boston/housing-market#recentlysold")
send <- read_html("https://www.redfin.com/neighborhood/2529/MA/Boston/South-End")
dorch <- read_html("https://www.redfin.com/neighborhood/708/MA/Boston/Dorchester/housing-market")
rox <- read_html("https://www.redfin.com/neighborhood/2344/MA/Boston/Roxbury/housing-market")
jp <- read_html("https://www.redfin.com/neighborhood/1381/MA/Boston/Jamaica-Plain/housing-market")
ros <- read_html("https://www.redfin.com/neighborhood/2341/MA/Boston/Roslindale/housing-market")
sbos <- read_html("https://www.redfin.com/neighborhood/2501/MA/Boston/South-Boston/housing-market")
bright <- read_html("https://www.redfin.com/neighborhood/38/MA/Boston/Brighton/housing-market")
nend <- read_html("https://www.redfin.com/neighborhood/186088/MA/Boston/North-End/housing-market")
ctown <- read_html("https://www.redfin.com/neighborhood/455/MA/Boston/Charlestown/housing-market")
bbay <- read_html("https://www.redfin.com/neighborhood/293571/MA/Boston/Back-Bay/housing-market")
hpark <- read_html("https://www.redfin.com/neighborhood/1329/MA/Boston/Hyde-Park/housing-market")
alls <- read_html("https://www.redfin.com/neighborhood/186267/MA/Boston/Allston/housing-market")
ebos <- read_html("https://www.redfin.com/neighborhood/795/MA/Boston/East-Boston/housing-market")
chesthill <- read_html("https://www.redfin.com/neighborhood/186297/MA/Newton/Chestnut-Hill/housing-market")
wrox <- read_html("https://www.redfin.com/neighborhood/3036/MA/Boston/West-Roxbury/housing-market")
beachill <- read_html("https://www.redfin.com/neighborhood/8607/MA/Boston/Beacon-Hill/housing-market")
ken <- read_html("https://www.redfin.com/neighborhood/18856/MA/Boston/Fenway-Kenmore-Square/housing-market")
sea <- read_html("https://www.redfin.com/neighborhood/186286/MA/Boston/Seaport-District/housing-market")
dt <- read_html("https://www.redfin.com/neighborhood/755/MA/Boston/Downtown-Boston/housing-market")
ct <- read_html("https://www.redfin.com/neighborhood/482/MA/Boston/Chinatown-Bay-Village/housing-market")
matta <- read_html("https://www.redfin.com/neighborhood/1640/MA/Boston/Mattapan/housing-market")
#technically not BOS
brook <-read_html("https://www.redfin.com/city/36099/MA/Brookline/housing-market")
camb <-read_html("https://www.redfin.com/city/2833/MA/Cambridge/housing-market")
somer <-read_html("https://www.redfin.com/city/16064/MA/Somerville/housing-market")

```


Scrape data from desired html_node.

```{r}

t.bos <- bos %>% html_node(".RealEstateTrends") %>% html_text()
t.send <- send %>% html_node(".RealEstateTrends") %>% html_text()
t.dorch <- dorch %>% html_node(".RealEstateTrends") %>% html_text()
t.rox <- rox %>% html_node(".RealEstateTrends") %>% html_text()
t.jp <- jp %>% html_node(".RealEstateTrends") %>% html_text()
t.ros <- ros %>% html_node(".RealEstateTrends") %>% html_text()
t.sbos <- sbos %>% html_node(".RealEstateTrends") %>% html_text()
t.bright <- bright %>% html_node(".RealEstateTrends") %>% html_text()
t.nend <- nend %>% html_node(".RealEstateTrends") %>% html_text()
t.ctown <- ctown %>% html_node(".RealEstateTrends") %>% html_text()
t.bbay <- bbay %>% html_node(".RealEstateTrends") %>% html_text()
t.hpark <- hpark %>% html_node(".RealEstateTrends") %>% html_text()
t.alls <- alls %>% html_node(".RealEstateTrends") %>% html_text()
t.ebos <- ebos %>% html_node(".RealEstateTrends") %>% html_text()
t.chesthill <- chesthill %>% html_node(".RealEstateTrends") %>% html_text()
t.wrox <- wrox %>% html_node(".RealEstateTrends") %>% html_text()
t.beachill <- beachill %>% html_node(".RealEstateTrends") %>% html_text()
t.ken <- ken %>% html_node(".RealEstateTrends") %>% html_text()
t.sea <- sea %>% html_node(".RealEstateTrends") %>% html_text()
t.dt <- dt %>% html_node(".RealEstateTrends") %>% html_text()
t.ct <- ct %>% html_node(".RealEstateTrends") %>% html_text()
t.matta <- matta %>% html_node(".RealEstateTrends") %>% html_text()
#technically not BOS
t.brook <- brook %>% html_node(".RealEstateTrends") %>% html_text()
t.camb <- camb %>% html_node(".RealEstateTrends") %>% html_text()
t.somer <- somer %>% html_node(".RealEstateTrends") %>% html_text()
```

Create function to string proccess scraped data. Final output is datatable.

```{r}

redfin.fun <- function(x) {
  x %>% str_split_fixed(pattern = "\\%", n=5) %>%
    str_replace_all("[^[:alnum:]]","") %>% 
    str_replace_all(c("KSalePrice\\d*"="000",
                    "MSalePrice\\d*"="000000",
                    "sincelastyear"="", 
                    "SaleSqFt\\d*"="",
                    "TotalHomesSold"="",
                    "K"="0"))
}

bos.list<-c(t.bos,
t.send,
t.dorch,
t.rox,
t.jp,
t.ros,
t.sbos,
t.bright,
t.nend,
t.ctown,
t.bbay,
t.hpark,
t.alls,
t.ebos,
t.chesthill,
t.wrox,
t.beachill,
t.ken,
t.sea,
t.dt,
t.ct,
t.matta,
t.brook,
t.camb,
t.somer)

rownames<-c("Boston",
"Bay Village South End",
"Dorchester",
"Roxbury",
"Jamaica Plain",
"Roslindale",
"South Boston",
"Brighton",
"North End West End",
"Charlestown",
"Back Bay",
"Hyde Park",
"Allston",
"East Boston",
"Chestnut Hill",
"West Roxbury",
"Beacon Hill",
"Fenway",
"Seaport District",
"Downtown",
"Chinatown Leather District",
"Mattapan",
"Brookline",
"Cambridge",
"Sommerville")

funoutput.boston<-lapply(bos.list, redfin.fun)
df.boston <- do.call(rbind, funoutput.boston) %>% 
  as_tibble()
colnames(df.boston)<-c("Avg Sale Price", "Price Per SqFt", "Diff from List Price", "Misc", "Number Sold")
df.boston <- cbind(df.boston, rownames) %>% 
  dplyr::select(-`Diff from List Price`, -Misc) %>% 
  dplyr::rename("Neighborhood"="rownames") %>% 
  mutate("Year"=2020) %>% 
  mutate_at(c("Avg Sale Price", "Price Per SqFt", "Number Sold"), as.numeric)
head(df.boston)
col_order <- c("Neighborhood", "Year", "Avg Sale Price", "Price Per SqFt", "Number Sold")
df.boston <- df.boston[, col_order]
df.boston <- df.boston %>% mutate("Type"=NA)
head(df.boston)

```

Historic data scraped from [Boston Magazine](https://www.bostonmagazine.com/best-places-to-live-2017-condos/).

```{r}
#condo data
condo_sixteen <- read_html("https://www.bostonmagazine.com/best-places-to-live-2017-condos/")
condo_nineteen <- read_html("https://www.bostonmagazine.com/property/top-places-to-live-2019-condos/")
condo_twenty <- read_html("https://www.bostonmagazine.com/property/top-places-to-live-2020-condos/")

#single family housing data
house_sixteen <- read_html("https://www.bostonmagazine.com/best-places-to-live-2017-single-family-homes/")
house_nineteen <- read_html("https://www.bostonmagazine.com/top-places-to-live-2019-single-family-homes/")
house_twenty <- read_html("https://www.bostonmagazine.com/property/single-family-home-prices/")

```

Identify correct table in html code. **OF NOTE, these are median prices for each neighborhood.**
Historic 2015 and 2016 data.

```{r}
#2015 and 2016 Condo data
#scrape and clean table data
t_condo_sixteen <- condo_sixteen %>% html_nodes("table") %>% html_table() %>% .[[1]] %>% 
  dplyr::select(-contains(c("Change", "Days on Market", "2006", "2011"))) %>% 
  mutate_all(funs(gsub("[[:punct:]]", "", .))) %>% 
  filter(str_detect(`Neighborhood / Town`, 'Boston|Brookline|Cambridge|Somerville')) %>%
  mutate_at(c(2:5), as.numeric) %>% 
  as_tibble()
col_order2 <-c("Neighborhood / Town", "2016 Median Price", "2016 Number of Sales", "2015 Median Price", "2015 Number of Sales")
t_condo_sixteen <- t_condo_sixteen[, col_order2]
head(t_condo_sixteen)

#convert data to long format
l_condo_sixteen <- t_condo_sixteen %>% gather(key = "Year" , value = "Value", -"Neighborhood / Town") %>% 
  separate(Year, c("Year", "Value Type"), extra = "merge") %>% 
  spread("Value Type", "Value") %>% 
  mutate_at("Year", as.numeric) %>% 
  arrange(Year) %>% 
  mutate("Type"="Condo", "Price Per SqFt"=NA)
colnames(l_condo_sixteen)<-c("Neighborhood", "Year", "Avg Sale Price", "Number Sold", "Type", "Price Per SqFt")
l_condo_sixteen <-l_condo_sixteen[, c("Neighborhood", "Year", "Avg Sale Price", "Price Per SqFt", "Number Sold", "Type")]
rename_hood <-str_replace_all(l_condo_sixteen$Neighborhood, c("Boston  "="", "  "=" "))
rename_hood
l_condo_sixteen <- l_condo_sixteen %>% mutate(Neighborhood=rename_hood)
head(l_condo_sixteen)

#2015 and 2016 single family house data
#scrape and clean table data
t_house_sixteen <- house_sixteen %>% html_nodes("table") %>% html_table() %>% .[[1]] %>% 
  dplyr::select(-contains(c("Change", "Days on Market", "2006", "2011"))) %>% 
  mutate_all(funs(gsub("[[:punct:]]", "", .))) %>% 
  filter(str_detect(`Neighborhood / Town`, 'Boston|Brookline|Cambridge|Somerville')) %>%
  mutate_at(c(2:5), as.numeric) %>% 
  as_tibble()
col_order2 <-c("Neighborhood / Town", "2016 Median Price", "2016 No. of Sales", "2015 Median Price", "2015 No. of Sales")
t_house_sixteen <- t_house_sixteen[, col_order2]
head(t_house_sixteen)

#convert data to long format
l_house_sixteen <- t_house_sixteen %>% gather(key = "Year" , value = "Value", -"Neighborhood / Town") %>% 
  separate(Year, c("Year", "Value Type"), extra = "merge") %>% 
  spread("Value Type", "Value") %>% 
  mutate_at("Year", as.numeric) %>% 
  arrange(Year) %>%
  mutate("Type" = "House", "Price Per SqFt"=NA)
colnames(l_house_sixteen)<-c("Neighborhood", "Year", "Avg Sale Price", "Number Sold", "Type", "Price Per SqFt")
l_house_sixteen <-l_house_sixteen[, c("Neighborhood", "Year", "Avg Sale Price", "Price Per SqFt", "Number Sold", "Type")]
rename_hood2 <-str_replace_all(l_house_sixteen$Neighborhood, c("Boston  "="", "  "=" "))
rename_hood2
l_house_sixteen <- l_house_sixteen %>% mutate(Neighborhood=rename_hood2)
head(l_house_sixteen)

```

Historic 2017 data. **NO No. Units Sold Data**
```{r}

#2017 and 2018 Condo data
#scrape and clean table data
t_condo_nineteen <- condo_nineteen %>% html_nodes("table") %>% html_table() %>% .[[1]] %>% 
  dplyr::select(-contains(c("Change", "Days on Market", "2013", "2008", "2018"))) %>% 
  mutate_all(funs(gsub("[[:punct:]]", "", .))) %>% 
  mutate_at(c(2:ncol(.)), as.numeric) %>% 
  as_tibble()
head(t_condo_nineteen)

#convert data to long format
l_condo_nineteen <- t_condo_nineteen %>% gather(key = "Year" , value = "Value", -"Boston Neighborhoods") %>% 
  separate(Year, c("Year", "Value Type"), extra = "merge") %>% 
  spread("Value Type", "Value") %>% 
  mutate_at("Year", as.numeric) %>% 
  arrange(Year) %>% 
  mutate("Price Per SqFt"=NA, "Number Sold"=NA, "Type"="Condo")
colnames(l_condo_nineteen)<-c("Neighborhood", "Year", "Avg Sale Price", "Price Per SqFt", "Number Sold", "Type")
rename_hood3 <-str_replace_all(l_condo_nineteen$Neighborhood, c("Bay VillageSouth End"="Bay Village South End", 
                                                              "ChinatownLeather Dist"="Chinatown Leather District",
                                                              "North EndWest End"="North End West End"))
l_condo_nineteen <- l_condo_nineteen %>% mutate(Neighborhood=rename_hood3)
head(l_condo_nineteen)


#2017 and 2018 single family house data
#scrape and clean table data
t_house_nineteen <- house_nineteen %>% html_nodes("table") %>% html_table() %>% .[[1]] %>% 
  dplyr::select(-contains(c("Change", "Days on Market", "2013", "2008", "2018"))) %>% 
  mutate_all(funs(gsub("[[:punct:]]", "", .))) %>% 
  filter(str_detect(`City/Town`, 'Boston|Brookline|Cambridge|Somerville')) %>%
  mutate_at(c(2:ncol(.)), as.numeric) %>% 
  as_tibble()
head(t_house_nineteen)

#convert data to long format
l_house_nineteen <- t_house_nineteen %>% gather(key = "Year" , value = "Value", -"City/Town") %>% 
  separate(Year, c("Year", "Value Type"), extra = "merge") %>% 
  spread("Value Type", "Value") %>% 
  mutate_at("Year", as.numeric) %>% 
  arrange(Year)%>% 
  mutate("Price Per SqFt"=NA, "Number Sold"=NA, "Type"="House")
colnames(l_house_nineteen)<-c("Neighborhood", "Year", "Avg Sale Price", "Price Per SqFt", "Number Sold", "Type")
head(l_house_nineteen)


```

Historic 2018 and 2019 data.
```{r}

#2018 and 2019 Condo data
#scrape and clean table data
t_condo_twenty <- condo_twenty %>% html_nodes("table") %>% html_table() %>% .[[1]] %>% 
  dplyr::select(-contains(c("Change", "DOM", "2009", "2014"))) %>% 
  mutate_all(funs(gsub("[[:punct:]]", "", .))) %>% 
  mutate_at(c(2:ncol(.)), as.numeric) %>% 
  as_tibble()
t_condo_twenty <- t_condo_twenty[, c("Neighborhood", "2019 Median Price", "2019 Number of Sales", "2018 Median Price", "2018 Number of Sales")]
head(t_condo_twenty)

#convert data to long format
l_condo_twenty <- t_condo_twenty %>% gather(key = "Year" , value = "Value", -"Neighborhood") %>% 
  separate(Year, c("Year", "Value Type"), extra = "merge") %>% 
  spread("Value Type", "Value") %>% 
  mutate_at("Year", as.numeric) %>% 
  arrange(Year) %>% 
  mutate("Type"="Condo", "Price Per SqFt"=NA)
colnames(l_condo_twenty)<-c("Neighborhood", "Year", "Avg Sale Price", "Number Sold", "Type", "Price Per SqFt")
l_condo_twenty <-l_condo_twenty[, c("Neighborhood", "Year", "Avg Sale Price", "Price Per SqFt", "Number Sold", "Type")]
rename_hood_20 <-str_replace_all(l_condo_twenty$Neighborhood, c("Bay VillageSouth End"="Bay Village South End", 
                                                              "ChinatownLeather District"="Chinatown Leather District",
                                                              "North EndWest End"="North End West End"))
l_condo_twenty <- l_condo_twenty %>% mutate(Neighborhood=rename_hood_20)
head(l_condo_twenty)

#2018 and 2019 single family house data
#scrape and clean table data
t_house_twenty <- house_twenty %>% html_nodes("table") %>% html_table() %>% .[[1]] %>% 
  dplyr::select(-contains(c("Change", "DOM", "2009", "2014"))) %>% 
  mutate_all(funs(gsub("[[:punct:]]", "", .))) %>% 
  filter(str_detect(`City/Town`, 'Boston|Brookline|Cambridge|Somerville')) %>%
  mutate_at(c(2:ncol(.)), as.numeric) %>% 
  as_tibble()
head(t_house_twenty)

#convert data to long format
l_house_twenty <- t_house_twenty %>% gather(key = "Year" , value = "Value", -"City/Town") %>% 
  separate(Year, c("Year", "Value Type"), extra = "merge") %>% 
  spread("Value Type", "Value") %>% 
  mutate_at("Year", as.numeric) %>% 
  arrange(Year) %>% 
  mutate("Price Per SqFt"=NA, "Number Sold" =NA, "Type"="Condo")
colnames(l_house_twenty)<-c("Neighborhood", "Year", "Avg Sale Price", "Price Per SqFt", "Number Sold", "Type")
head(l_house_twenty)


```

Combining all of the dataframes for 2015, 2016, 2017, 2018, 2019, 2020.
Datatable information: 
This table includes aggregate data from all neighborhoods of Boston. The 2015-2019 data is from [Boston Magazine](https://www.bostonmagazine.com/best-places-to-live-2017-condos/) and the associated pages of each year. The 2020 data is from [Redfin](https://www.redfin.com/city/1826/MA/Boston/housing-market) and the associated individual neighborhood pages.

Description of data within columns:
* Neighborhood - factor w 27 levels; includes all neighborhoods of Boston (Allston, Back Bay, Bay Village South End, Beacon Hill, Brighton, Charlestown, Chestnut Hill, Chinatown Leather District, Dorchester, Downtown, East Boston, Fenway, Hyde Park, Jamaica Plain, Mattapan, North End West End, Roslindale, Roxbury, Seaport District, South Boston, West Roxbury, Citywide). __Of note__, data is only available for Seaport District and Downtown, and Chestnut Hill in _Redfin_. Data is only available for Citywide in _Boston Magazine_. Brookline, Cambridge, and Sommerville were included as neighborhoods of interest althought they are not considered to be in Boston. The row for Boston is a composite measurement that is included in both Redfin and some of the Boston Magazine data.
* Year - number
* Avg Sale Price - number; median price was used for _Boston Magazine_, unclear which measurement was used to calculate the average sale price listed by _Redfin_.
* Price Per SqFt - number; only available for Redfin data.
* Number Sold - number; units sold in that neighborhood, missing from _Boston Magazine_ 2017 data.
* Type - character; _Boston Magazine_ data was stratified by condo verses single family housing units. In the 2015 and 2016 data both condo and single family housing data was available for the neighborhoods of Boston and Brookline, Cambridge, Sommerville. Subsequent years condo data is only availble for the neighborhoods of Boston while housing data is only for Brookline, Cambridge, Sommerville, and the composite Boston category.


```{r}
df.bos.housing <-rbind(df.boston, l_condo_sixteen, l_house_sixteen, l_condo_nineteen, l_house_nineteen, l_condo_twenty, l_house_twenty)
df.bos.housing <-df.bos.housing %>% arrange(Year)
view(df.bos.housing)
dim(df.bos.housing)
```
